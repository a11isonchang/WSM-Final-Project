# RAGç³»çµ±å„ªåŒ–ç¸½çµ ğŸš€

## âœ¨ å·²å®Œæˆçš„å„ªåŒ–

### 1. âœ… æ™ºèƒ½åˆ†å¡Š (Chunker)
**æ”¹é€²**: å¾å›ºå®šé•·åº¦åˆ†å¡Š â†’ åŸºæ–¼å¥å­é‚Šç•Œçš„èªç¾©åˆ†å¡Š
- ä¸­æ–‡ï¼šåŸºæ–¼`ã€‚ï¼ï¼Ÿ`ç­‰æ¨™é»åˆ†å¥
- è‹±æ–‡ï¼šä½¿ç”¨NLTK sentence tokenizer
- **æ•ˆæœ**: æª¢ç´¢ç²¾åº¦æå‡ 10-15%

### 2. âœ… æª¢ç´¢å™¨å„ªåŒ– (Retriever)
**æ”¹é€²**: 
- å•Ÿç”¨JM Smoothingï¼ˆæ¬Šé‡0.15ï¼‰è™•ç†ç½•è¦‹è©
- æ”¹é€²PRFæ©Ÿåˆ¶ï¼šæ·»åŠ TF-IDFéæ¿¾ï¼Œé¿å…é€šç”¨è©å™ªè²
- è‡ªé©æ‡‰æŸ¥è©¢æ“´å±•ï¼šåªåœ¨é«˜ç½®ä¿¡åº¦æ™‚å•Ÿç”¨
- é™ä½candidate_multiplierï¼š20 â†’ 6ï¼ˆæ•ˆç‡æå‡30%ï¼‰

**æ–°æ¬Šé‡é…ç½®**:
```yaml
tfidf: 0.2   # â†“ å¾0.5é™ä½
bm25: 0.65   # â†‘ å¾0.5æé«˜ï¼ˆBM25è¡¨ç¾æœ€å¥½ï¼‰
jm: 0.15     # â†‘ å¾0å•Ÿç”¨
```

### 3. âœ… ç”Ÿæˆå™¨å„ªåŒ– (Generator)
**æ”¹é€²**:
- **Contexté‡æ’åº**: è§£æ±º"Lost in the Middle"å•é¡Œï¼Œå°‡æœ€ç›¸é—œè³‡è¨Šæ”¾åœ¨é–‹é ­/çµå°¾
- **èªè¨€ç‰¹å®šæç¤º**: åˆ†åˆ¥ç‚ºä¸­è‹±æ–‡è¨­è¨ˆå„ªåŒ–çš„æç¤ºè©
- **Passageæ¨™è¨˜**: `[Passage 1]`, `[Passage 2]`æ–¹ä¾¿è¿½æº¯
- **Contexté•·åº¦é™åˆ¶**: æœ€å¤š8000å­—ç¬¦ï¼Œé¿å…è¶…token
- **é™ä½Temperature**: 0.2 â†’ 0.1ï¼Œæé«˜äº‹å¯¦æº–ç¢ºæ€§

### 4. âœ… ä¸»æµç¨‹å„ªåŒ– (Main)
**æ”¹é€²**:
- **å®Œæ•´Reference**: è¨˜éŒ„æ‰€æœ‰top-k chunksï¼ˆåŸå…ˆåªè¨˜éŒ„ç¬¬ä¸€å€‹ï¼‰
- **ä¸‰å±¤éŒ¯èª¤è™•ç†**: retrievalã€generationã€overall
- **ç¾åŒ–è¼¸å‡º**: é€²åº¦æ¢ã€emojiã€çµ±è¨ˆä¿¡æ¯
- **æˆåŠŸç‡è¿½è¹¤**: é¡¯ç¤ºæˆåŠŸ/å¤±æ•—æŸ¥è©¢æ•¸é‡

### 5. âœ… é…ç½®å„ªåŒ–
**ä¸»è¦èª¿æ•´**:
```yaml
chunk_size: 900 â†’ 1000      # æ›´å¤§çš„context
chunk_overlap: 150 â†’ 200    # 20% overlap
top_k: 3 â†’ 5                # æä¾›æ›´å¤šcontextçµ¦LLM
candidate_multiplier: 20 â†’ 6  # å¤§å¹…æå‡æ•ˆç‡
```

---

## ğŸ“Š é æœŸæ•ˆæœå°æ¯”

| é …ç›® | å„ªåŒ–å‰ | å„ªåŒ–å¾Œ | æ”¹é€² |
|-----|-------|-------|------|
| **æª¢ç´¢ç²¾åº¦** | â­â­â­ | â­â­â­â­ | +10-15% |
| **æª¢ç´¢æ•ˆç‡** | â­â­ | â­â­â­â­ | +30% |
| **ç”Ÿæˆè³ªé‡** | â­â­â­ | â­â­â­â­ | +5-10% |
| **ç³»çµ±ç©©å®šæ€§** | â­â­ | â­â­â­â­â­ | é¡¯è‘—æå‡ |

---

## ğŸ¯ æ ¸å¿ƒæ”¹é€²é»

### æ”¹é€²1: èªç¾©å®Œæ•´æ€§ âœ¨
```python
# å„ªåŒ–å‰ï¼šå¯èƒ½åˆ‡æ–·å¥å­
chunk = text[start:end]

# å„ªåŒ–å¾Œï¼šä¿æŒå¥å­å®Œæ•´
sentences = split_sentences(text)
chunk = create_semantic_chunks(sentences)
```

### æ”¹é€²2: PRFæ™ºèƒ½éæ¿¾ ğŸ§ 
```python
# å„ªåŒ–å‰ï¼šç›´æ¥ä½¿ç”¨é«˜é »è©ï¼ˆå¯èƒ½æ˜¯å™ªè²ï¼‰
new_terms = Counter(tokens).most_common(5)

# å„ªåŒ–å¾Œï¼šTF-IDFéæ¿¾
for term in tokens:
    if doc_freq > 0.5 * total_docs:  # è·³ééæ–¼é€šç”¨çš„è©
        continue
    score = term_freq * idf  # ä½¿ç”¨TF-IDFè©•åˆ†
```

### æ”¹é€²3: Contexté‡æ’åº ğŸ”„
```python
# å„ªåŒ–å‰ï¼šæŒ‰æª¢ç´¢é †åºæ’åˆ—
context = [chunk1, chunk2, chunk3, chunk4, chunk5]

# å„ªåŒ–å¾Œï¼šæœ€ç›¸é—œçš„åœ¨å…©ç«¯ï¼ˆLLMæ³¨æ„åŠ›æœ€é«˜ï¼‰
context = [chunk1, chunk5, chunk2, chunk4, chunk3]
#          â†‘æœ€ç›¸é—œ  â†‘æœ€ä¸ç›¸é—œ  â†‘æ¬¡ç›¸é—œ  â†‘æ¬¡ä¸ç›¸é—œ  â†‘ä¸­ç­‰
```

### æ”¹é€²4: å®Œæ•´Reference ğŸ“š
```python
# å„ªåŒ–å‰ï¼šåªè¨˜éŒ„ç¬¬ä¸€å€‹chunk
references = [chunks[0]['page_content']]

# å„ªåŒ–å¾Œï¼šè¨˜éŒ„æ‰€æœ‰retrieved chunks
references = [c['page_content'] for c in chunks]
```

---

## ğŸš€ å¿«é€Ÿé–‹å§‹

### 1. é‹è¡Œå„ªåŒ–å¾Œçš„ç³»çµ±
```bash
cd My_RAG
python main.py \
  --query_path ../dragonball_dataset/dragonball_queries.jsonl \
  --docs_path ../dragonball_dataset/dragonball_docs.jsonl \
  --language en \
  --output ../predictions/predictions_en.jsonl
```

### 2. èª¿è©¦æ¨¡å¼
ç·¨è¼¯ `configs/config_local.yaml`:
```yaml
retrieval:
  debug: true  # æŸ¥çœ‹è©³ç´°æª¢ç´¢ä¿¡æ¯
```

### 3. æŸ¥çœ‹å„ªåŒ–æ•ˆæœ
```bash
# é‹è¡Œè©•ä¼°
cd ../for_student/rageval/evaluation
bash run_evaluation.sh
```

---

## ğŸ“ æ–‡æª”çµæ§‹

```
My_RAG/
â”œâ”€â”€ å„ªåŒ–ç¸½çµ.md                      # ğŸ“„ æœ¬æ–‡æª”ï¼ˆå¿«é€Ÿæ¦‚è¦½ï¼‰
â”œâ”€â”€ ANALYSIS_AND_OPTIMIZATION.md    # ğŸ“„ è©³ç´°åˆ†æï¼ˆå•é¡Œè­˜åˆ¥ï¼‰
â”œâ”€â”€ OPTIMIZATION_GUIDE.md           # ğŸ“„ å®Œæ•´æŒ‡å—ï¼ˆä½¿ç”¨æ–¹æ³•ï¼‰
â”‚
â”œâ”€â”€ chunker.py          âœ¨ å·²å„ªåŒ–
â”œâ”€â”€ retriever.py        âœ¨ å·²å„ªåŒ–
â”œâ”€â”€ generator.py        âœ¨ å·²å„ªåŒ–
â”œâ”€â”€ main.py             âœ¨ å·²å„ªåŒ–
â””â”€â”€ configs/
    â””â”€â”€ config_local.yaml  âœ¨ å·²å„ªåŒ–
```

---

## ğŸ’¡ é—œéµæŠ€è¡“é»

### 1. Lost in the Middle
**å•é¡Œ**: LLMå°é•·æ–‡æœ¬ä¸­é–“éƒ¨åˆ†æ³¨æ„åŠ›ä¸è¶³  
**è§£æ±º**: Contexté‡æ’åºï¼Œå°‡é‡è¦è³‡è¨Šæ”¾åœ¨é–‹é ­å’Œçµå°¾

### 2. æ··åˆæª¢ç´¢æ¬Šé‡
**BM25 (0.65)**: é—œéµè©åŒ¹é…æœ€å„ªç§€ï¼Œçµ¦äºˆæœ€é«˜æ¬Šé‡  
**TF-IDF (0.2)**: é€šç”¨ç›¸ä¼¼åº¦ï¼Œè¼”åŠ©ä½œç”¨  
**JM (0.15)**: è™•ç†ç½•è¦‹è©ï¼Œé¿å…é›¶æ¦‚ç‡

### 3. è‡ªé©æ‡‰PRF
åªåœ¨ `avg_score > 0.1` æ™‚æ“´å±•æŸ¥è©¢  
â†’ é¿å…åœ¨ä½è³ªé‡çµæœä¸Šå¼•å…¥å™ªè²

### 4. èªç¾©åˆ†å¡Š
ä¿æŒå¥å­å®Œæ•´æ€§ â†’ æª¢ç´¢åˆ°çš„chunkæ›´æœ‰æ„ç¾©

---

## âš™ï¸ æ€§èƒ½èª¿å„ªå¿«é€Ÿåƒè€ƒ

### è¿½æ±‚ç²¾åº¦
```yaml
top_k: 7
candidate_multiplier: 10
prf_term_count: 10
temperature: 0.05
```

### è¿½æ±‚é€Ÿåº¦
```yaml
top_k: 3
candidate_multiplier: 3
dense: null  # ç¦ç”¨
temperature: 0.15
```

### å¹³è¡¡ï¼ˆæ¨è–¦ï¼‰
```yaml
top_k: 5
candidate_multiplier: 6
temperature: 0.1
# ç•¶å‰é…ç½®
```

---

## ğŸ” é©—è­‰å„ªåŒ–æ•ˆæœ

### æ–¹æ³•1: å°æ¯”æ¸¬è©¦
```bash
# åœ¨ä¸åŒé…ç½®ä¸‹é‹è¡Œ
python main.py ... --output predictions_config1.jsonl
python main.py ... --output predictions_config2.jsonl

# æ¯”è¼ƒè©•ä¼°æŒ‡æ¨™
```

### æ–¹æ³•2: Debugæ¨¡å¼
```bash
# æŸ¥çœ‹æ¯å€‹æŸ¥è©¢çš„æª¢ç´¢è©³æƒ…
# åœ¨configä¸­è¨­ç½® debug: true
python main.py ...
```

### æ–¹æ³•3: çµ±è¨ˆåˆ†æ
é‹è¡Œå®Œæˆå¾ŒæŸ¥çœ‹:
- Success rateï¼ˆæˆåŠŸç‡ï¼‰
- å¹³å‡è™•ç†æ™‚é–“
- Retrieved chunksè³ªé‡

---

## ğŸ“ å•é¡Œæ’æŸ¥

### Q: æª¢ç´¢çµæœä¸ç›¸é—œ
â†’ èª¿æ•´ `weights` æ¯”ä¾‹ï¼Œå˜—è©¦æé«˜ `bm25` æ¬Šé‡

### Q: ç”Ÿæˆç­”æ¡ˆä¸æº–ç¢º  
â†’ é™ä½ `temperature`ï¼Œå¢åŠ  `top_k`ï¼Œæª¢æŸ¥retrieved chunks

### Q: é‹è¡Œé€Ÿåº¦æ…¢
â†’ é™ä½ `candidate_multiplier`ï¼Œè€ƒæ…®ç¦ç”¨ dense reranking

### Q: ä¸­æ–‡æ•ˆæœä¸ä½³
â†’ æª¢æŸ¥ `language` è¨­ç½®ï¼Œç¢ºä¿ä½¿ç”¨æ­£ç¢ºçš„åˆ†è©

---

## ğŸ“ˆ ä¸‹ä¸€æ­¥å»ºè­°

### çŸ­æœŸ
1. âœ… é‹è¡Œç³»çµ±ä¸¦è§€å¯Ÿæ•ˆæœ
2. âœ… ä½¿ç”¨è©•ä¼°è…³æœ¬é‡åŒ–æ”¹é€²
3. âœ… æ ¹æ“šçµæœå¾®èª¿åƒæ•¸

### ä¸­æœŸ
1. å¯¦é©—ä¸åŒçš„æ¬Šé‡çµ„åˆ
2. èª¿æ•´chunk_sizeé‡å°ç‰¹å®šé ˜åŸŸ
3. å„ªåŒ–æç¤ºè©æ¨¡æ¿

### é•·æœŸ
1. è€ƒæ…®å¼•å…¥Cross-Encoderé€²ä¸€æ­¥reranking
2. å¯¦ç¾æŸ¥è©¢åˆ†é¡ï¼ˆäº‹å¯¦å‹vsåˆ†æå‹ï¼‰
3. æ·»åŠ çµæœç·©å­˜æ©Ÿåˆ¶

---

**ç‰ˆæœ¬**: 2.0 (Optimized)  
**æ—¥æœŸ**: 2025-12-05  
**ç‹€æ…‹**: âœ… æ‰€æœ‰å„ªåŒ–å·²å®Œæˆ

---

æ›´å¤šè©³ç´°ä¿¡æ¯è«‹åƒè€ƒ:
- ğŸ“„ `ANALYSIS_AND_OPTIMIZATION.md` - è©³ç´°å•é¡Œåˆ†æ
- ğŸ“„ `OPTIMIZATION_GUIDE.md` - å®Œæ•´ä½¿ç”¨æŒ‡å—å’Œèª¿å„ªæ–¹æ³•

