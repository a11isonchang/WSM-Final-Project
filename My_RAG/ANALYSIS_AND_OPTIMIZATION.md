# RAG系統架構分析與優化方案

## 📋 目前架構流程

### 1. 主流程 (main.py)
```
載入數據 → 文檔分塊 → 創建檢索器 → 對每個查詢檢索 → 生成答案 → 保存結果
```

### 2. 各模組功能

#### **Chunker (chunker.py)**
- 使用固定長度滑動窗口分塊
- chunk_size: 900, overlap: 150
- 按語言過濾文檔

#### **Retriever (retriever.py)**
- **混合檢索**: TF-IDF + BM25 + JM Smoothing
- **當前權重**: tfidf=0.5, bm25=0.5, jm=0
- **伪相关反馈 (PRF)**: 從top-3文檔提取5個關鍵詞擴展查詢
- **Dense Re-ranking**: 使用msmarco-MiniLM-L-6-v3
- **候選集擴展**: candidate_multiplier=20倍

#### **Generator (generator.py)**
- 使用Ollama API (granite4:3b模型)
- Temperature: 0.2 (低溫度以提高事實準確性)
- 嚴格基於檢索上下文回答

---

## 🔍 問題分析

### 問題1: 分塊策略不夠智能
**現況**: 固定長度分塊，可能切斷語義完整的段落
**影響**: 檢索到的chunk可能缺少完整信息

### 問題2: 檢索權重配置待優化
**現況**: 
- JM Smoothing權重為0（未啟用）
- candidate_multiplier=20倍過大，計算開銷高
**影響**: 檢索效果可能不是最優，且效率低

### 問題3: PRF可能引入噪聲
**現況**: 直接從top-3文檔提取詞彙，未過濾
**影響**: 可能加入不相關的擴展詞

### 問題4: Reference不完整
**現況**: 只使用第一個chunk作為reference
**影響**: 評估時可能遺漏其他相關chunk

### 問題5: 生成提示可以更優化
**現況**: 沒有針對不同語言和查詢類型調整
**影響**: 生成質量可能不穩定

### 問題6: 缺少錯誤處理和日誌
**現況**: 沒有完善的異常處理機制
**影響**: 調試困難，系統穩定性低

---

## 🚀 優化方案

### 優化1: 智能分塊策略 ⭐⭐⭐
**方法**:
- 基於句子邊界分塊
- 中文使用句號、問號、感嘆號分句
- 英文使用nltk sentence tokenizer
- 保持chunk語義完整性

**預期效果**: 提高檢索精度10-15%

### 優化2: 檢索器參數調優 ⭐⭐⭐
**方法**:
- 調整候選集倍數從20降至5-10
- 啟用JM Smoothing (權重0.1-0.2)
- 實驗不同的權重組合
- 添加query expansion智能過濾

**預期效果**: 提高檢索效率30%，維持或提升精度

### 優化3: 改進PRF機制 ⭐⭐
**方法**:
- 添加TF-IDF過濾，只保留高質量擴展詞
- 避免過於通用的詞彙
- 根據查詢類型調整擴展策略

**預期效果**: 降低噪聲，提高查詢擴展質量

### 優化4: 完善Reference輸出 ⭐⭐⭐
**方法**:
- 將所有檢索到的top-k chunks作為references
- 添加metadata信息
- 提供更完整的來源追溯

**預期效果**: 評估指標更準確

### 優化5: 優化生成提示 ⭐⭐⭐
**方法**:
- 針對中英文設計不同提示模板
- 添加上下文排序和過濾
- 改進指令清晰度
- 添加思維鏈提示

**預期效果**: 提高生成質量5-10%

### 優化6: 添加Context重排序 ⭐⭐
**方法**:
- 在送入LLM前對retrieved chunks重新排序
- 將最相關的放在開頭和結尾（Lost in the Middle問題）
- 限制總token數量

**預期效果**: 提高LLM利用上下文的效果

### 優化7: 增強錯誤處理和日誌 ⭐
**方法**:
- 添加try-catch錯誤處理
- 添加結構化日誌
- 添加性能監控

**預期效果**: 提高系統穩定性和可維護性

---

## 📊 優化優先級

1. **高優先級** (立即實施):
   - 智能分塊策略
   - 完善Reference輸出
   - 優化生成提示
   - 檢索器參數調優

2. **中優先級** (後續實施):
   - Context重排序
   - 改進PRF機制

3. **低優先級** (維護性改進):
   - 增強錯誤處理和日誌

---

## 🎯 實施計劃

本次優化將實施以下改進:
1. ✅ 智能分塊（基於句子邊界）
2. ✅ 檢索器參數優化（調整candidate_multiplier和權重）
3. ✅ 完善Reference輸出（使用所有top-k chunks）
4. ✅ 優化生成提示（分中英文，添加思維鏈）
5. ✅ Context重排序（避免Lost in the Middle）
6. ✅ 添加基本錯誤處理

